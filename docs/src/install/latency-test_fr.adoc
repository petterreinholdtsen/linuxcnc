:lang: fr
:toc:

[[cha:latency-test]](((Latency Test)))

= Test des capacités temps réel

Ce test est le premier test qui doit être effectué sur un PC
pour savoir si celui-ci est capable de piloter une machine CNC.

La latence correspond au temps pris par le PC pour stopper ce qui est
en cours et répondre à une requête externe. Dans notre cas, la requête
est l'horloge qui sert au cadencement des impulsions de pas. Plus basse
est la latence, plus rapide pourra être l'horloge, plus rapides et plus
douces seront les
impulsions de pas.

La latence est de loin plus importante que la vitesse du CPU.
Un vieux Pentium III qui répond aux interruptions avec 10 microsecondes
entre chacune, peut donner de meilleurs résultats que le dernier modèle
de µP ultra rapide.

Le CPU n'est pas le seul facteur déterminant le temps de latence.
Les cartes mères, les cartes vidéo, les ports USB et
de nombreuses autres choses peuvent détériorer le temps de latence.
FIXME The best way to find out what you are dealing with is
to run the RTAI latency test.

FIXME Generating step pulses in software
has one very big advantage - it's free.
Just about every PC has a parallel port that is
capable of outputting step pulses that are generated by the software.
However, software step pulses
also have some disadvantages:

- limited maximum step rate
- jitter in the generated pulses
- loads the CPU

La meilleure façon de savoir si le matériel envisagé est apte, c'est
d'exécuter _un test de latence_.
Pour exécuter ce test, ouvrir une fenêtre de terminal
à partir de _Applications → Accessoires → Terminal_ et
exécuter la commande suivante:

----
latency-test
----

Une fenêtre comme ci-dessous devrait s'ouvrir:

image::../config/images/latency.png["Test de latence de HAL",align="center"]

Alors que le test est en cours d'exécution, il faut charger l'ordinateur au
maximum. Déplacer les fenêtres sur l'écran. Surfer sur le Web. Écouter de la
musique.
Exécuter un programme OpenGL comme glxgears. L'idée est de charger le
PC au maximum pour que le temps de latence soit mesuré dans le cas le plus
défavorable et donc, connaitre la latence maximale.

[NOTE]
Ne pas exécuter LinuxCNC ou Stepconf pendant que latency-test est en cours d'exécution.

La colonne 'max jitter' et la ligne 'Base Thread' de l'exemple ci-dessus
donne _9075_. Ce qui représente 9075 nanosecondes, soit 9.075 microsecondes.
Noter ce nombre et l'entrer dans Stepconf quand il sera demandé.

Dans cet exemple de test de latence il n'a fallu que quelques
secondes pour afficher cette valeur. Il est toutefois préférable de le laisser
tourner pendant plusieurs minutes. Parfois même, dans le pire des
cas, rien ne provoque de latence ou seulement des actions particulières.
Par exemple, une carte mère Intel marchait très bien
la plupart du temps, mais toutes les 64 secondes elle avait une
très mauvaise latence de 300µs. Heureusement, il existe un http://wiki.linuxcnc.org/cgi-bin/wiki.pl?FixingSMIIssues[correctif].

Alors, comment interpréter les résultats? Si le résultat de Max Jitter est en
dessous d'environ 15-20 µs (15000-20000
nanosecondes), l'ordinateur pourra donner d'excellents résultats
pour la génération logicielle des pas. Si le temps de latence est à
plus de 30-50 microsecondes, de bons résultats seront obtenus, mais la
vitesse maximum sera un peu faible, spécialement si des micropas sont
utilisés ou si le pas de la vis est fin. Si les résultats sont de 100µS
ou plus (100,000 nanosecondes), alors le PC
n'est pas un bon candidat à la génération des pas. Les résultats
supérieurs à 1 milliseconde (1,000,000 nanosecondes) éliminent,
dans tous les cas, ce PC pour faire tourner LinuxCNC, en utilisant des micropas ou pas.

[NOTE]
Si une latence élevée est obtenue, il peut être possible de l'améliorer.
Un PC avait une très mauvaise latence (plusieurs millisecondes) en utilisant
la carte graphique interne. Un carte graphique d'occasion à $5US a résolu le
problème.
LinuxCNC n'exige pas de matériel de pointe.

For more information on stepper tuning see the
<<cha:Stepper-Tuning,Stepper Tuning>> Chapter.

Additional command line tools are available for examining latency
when LinuxCNC is not running.

latency-plot makes a strip chart recording for a base and a servo thread.
It may be useful to see spikes in latency when other
applications are started or used. Usage:

----
latency-plot --help

Usage:
      latency-plot --help | -?
      latency-plot --hal [Options]

Options:
      --base nS  (base  thread interval, default:   25000)
      --servo nS (servo thread interval, default: 1000000)
      --time mS  (report interval, default: 1000)
      --relative (relative clock time (default))
      --actual   (actual clock time)
----

image::../config/images/latency-plot.png["latency-plot makes a strip chart recording for a base and a servo thread"]

latency-histogram displays a histogram of latency (jitter) for
a base and servo thread.

----
Usage:
   latency-histogram --help | -?
   latency-histogram [Options]

Options:
  --base      nS   (base  thread interval, default:   25000, min:  5000)
  --servo     nS   (servo thread interval, default: 1000000, min: 25000)
  --bbinsize  nS   (base  bin size,  default: 100
  --sbinsize  nS   (servo bin size, default: 100
  --bbins     n    (base  bins, default: 200
  --sbins     n    (servo bins, default: 200
  --logscale  0|1  (y axis log scale, default: 1)
  --text      note (additional note, default: "" )
  --show           (show count of undisplayed bins)
  --nobase         (servo thread only)
  --verbose        (progress and debug)
  --nox            (no gui, display elapsed,min,max,sdev for each thread)

Notes:
  Linuxcnc and Hal should not be running, stop with halrun -U.
  Large number of bins and/or small binsizes will slow updates.
  For single thread, specify --nobase (and options for servo thread).
  Measured latencies outside of the +/- bin range are reported
  with special end bars.  Use --show to show count for
  the off-chart [pos|neg] bin
----

image::../config/images/latency-histogram.png["latency-histogram displays a histogram of latency (jitter) for a base and servo thread"]

// vim: set syntax=asciidoc:
